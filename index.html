<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Medrunner Logistics - Equipment Request Portal</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="medrunner-config.js"></script>
  <script src="medrunner-auth.js"></script>
  <style>
    :root {
      --medrunner-primary: #2c5278;
      --medrunner-primary-dark: #1e3a52;
      --medrunner-primary-light: #3d6b94;
      --medrunner-bg-primary: #1f2937;
      --medrunner-bg-secondary: #1d2735;
      --medrunner-border: rgba(44, 82, 120, 0.3);
      --medrunner-text-primary: #ffffff;
      --medrunner-text-secondary: #d1d5db;
      --medrunner-text-muted: #9ca3af;
    }

    html {
      scroll-behavior: smooth;
    }

    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--medrunner-bg-primary) 0%, #111827 100%);
      min-height: 100vh;
    }

    .hero-gradient {
      background: linear-gradient(135deg,
        rgba(44, 82, 120, 0.1) 0%,
        rgba(29, 39, 53, 0.9) 50%,
        rgba(31, 41, 55, 0.95) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid var(--medrunner-border);
    }

    .equipment-card {
      background: linear-gradient(145deg, var(--medrunner-bg-secondary) 0%, #1a202c 100%);
      border: 1px solid var(--medrunner-border);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
    }

    .equipment-card:hover {
      border-color: var(--medrunner-primary);
      box-shadow: 0 20px 40px rgba(44, 82, 120, 0.15);
      transform: translateY(-4px);
    }

    .equipment-image {
      aspect-ratio: 16/9;
      object-fit: cover;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .equipment-image:hover {
      transform: scale(1.05);
    }

    .professional-card, .equipment-card {
      background: linear-gradient(145deg, var(--medrunner-bg-secondary) 0%, #1a202c 100%);
      border: 1px solid var(--medrunner-border);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(15px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .professional-card:hover, .equipment-card:hover {
      border-color: var(--medrunner-primary);
      box-shadow: 0 12px 40px rgba(44, 82, 120, 0.15);
      transform: translateY(-3px);
    }

    .professional-button {
      background: linear-gradient(135deg, var(--medrunner-primary) 0%, var(--medrunner-primary-dark) 100%);
      border: none;
      color: var(--medrunner-text-primary);
      font-weight: 600;
      letter-spacing: 0.025em;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(44, 82, 120, 0.3);
      border-radius: 0.75rem;
    }

    .professional-button:hover {
      background: linear-gradient(135deg, var(--medrunner-primary-dark) 0%, #16293d 100%);
      box-shadow: 0 8px 25px rgba(44, 82, 120, 0.4);
      transform: translateY(-2px);
    }

    .professional-button-secondary {
      background: transparent;
      border: 2px solid var(--medrunner-primary);
      color: var(--medrunner-primary);
      font-weight: 600;
      letter-spacing: 0.025em;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 0.75rem;
    }

    .professional-button-secondary:hover {
      background: var(--medrunner-primary);
      border-color: var(--medrunner-primary);
      color: var(--medrunner-text-primary);
      transform: translateY(-1px);
    }

    .section-header {
      background: linear-gradient(90deg, transparent 0%, rgba(44, 82, 120, 0.1) 50%, transparent 100%);
      border-bottom: 2px solid var(--medrunner-border);
      padding: 1.5rem 0;
      margin-bottom: 3rem;
      position: relative;
    }

    .section-header::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--medrunner-primary), transparent);
    }

    .nav-link {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 0.75rem;
    }

    .nav-link:hover {
      background: linear-gradient(135deg, rgba(44, 82, 120, 0.15), rgba(44, 82, 120, 0.1));
      color: var(--medrunner-primary) !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(44, 82, 120, 0.2);
    }

    .dropdown-link {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .dropdown-link:hover {
      background: linear-gradient(135deg, rgba(44, 82, 120, 0.2), rgba(44, 82, 120, 0.1));
      color: var(--medrunner-primary) !important;
      padding-left: 2rem;
      border-left: 3px solid var(--medrunner-primary);
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .professional-card, .equipment-card {
        margin: 0.5rem;
      }

      .grid-cols-3 {
        grid-template-columns: 1fr;
      }

      .nav-link {
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
      }

      #cart-sidebar {
        width: 100vw;
      }

      .text-5xl, .text-6xl, .text-7xl, .text-8xl {
        font-size: 2.5rem;
      }

      .md\:text-7xl, .md\:text-8xl {
        font-size: 3rem;
      }
    }
  </style>
</head>
<body class="text-white font-sans" style="background-color: #1f2937;">

  <section class="relative min-h-screen flex items-center justify-center overflow-hidden" id="hero-section">
    <div class="absolute inset-0 bg-gradient-to-br from-gray-900 via-blue-900/30 to-gray-900"></div>
    <div class="absolute inset-0 opacity-10">
      <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-blue-500 rounded-full mix-blend-multiply filter blur-xl animate-pulse"></div>
      <div class="absolute top-3/4 right-1/4 w-96 h-96 bg-blue-600 rounded-full mix-blend-multiply filter blur-xl animate-pulse" style="animation-delay: 2s;"></div>
      <div class="absolute bottom-1/4 left-1/2 w-96 h-96 bg-blue-400 rounded-full mix-blend-multiply filter blur-xl animate-pulse" style="animation-delay: 4s;"></div>
    </div>

    <div class="relative z-10 w-full mx-auto px-6 grid xl:grid-cols-2 gap-6 xl:gap-12 items-center max-w-7xl">
      <div class="text-left flex flex-col justify-between h-full">
        <div>
          <div class="flex items-start gap-6 mb-8">
            <div class="inline-flex items-center justify-center w-32 h-32 rounded-2xl shadow-xl flex-shrink-0" style="background-color: #AA0000;">
              <img src="Logi Logo.webp" alt="Logiistics Logo" class="w-28 h-28 object-contain">
            </div>

            <h1 class="text-5xl lg:text-6xl font-bold leading-tight">
              <span class="bg-gradient-to-r from-white via-blue-100 to-blue-200 bg-clip-text text-transparent">
                Medrunner
              </span>
              <br>
              <span class="bg-gradient-to-r from-blue-400 via-blue-500 to-blue-600 bg-clip-text text-transparent">
                Logistics
              </span>
            </h1>
          </div>

          <p class="text-xl text-gray-300 mb-8 leading-relaxed max-w-lg">
            For all your equipment and supply needs.
          </p>
        </div>

        <div class="flex flex-col md:flex-row gap-4">
          <a href="#kits" class="professional-button w-full px-8 py-4 text-lg font-semibold inline-flex items-center justify-center space-x-3 group">
            <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
              <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"></path>
            </svg>
            <span>Browse Equipment</span>
            <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
          </a>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-6">
        <div class="hero-gradient rounded-3xl p-8 border border-blue-500/20">
          <div class="grid grid-cols-2 gap-6">
            <div class="text-center">
              <div class="text-3xl font-bold text-blue-400 mb-2">24 Hour</div>
              <div class="text-sm text-gray-300">Availablility</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-green-400 mb-2">FREE</div>
              <div class="text-sm text-gray-300">All Equipment</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-purple-400 mb-2">48 Hour</div>
              <div class="text-sm text-gray-300">Collection Time</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-yellow-400 mb-2">100%</div>
              <div class="text-sm text-gray-300">Satisfaction</div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-6 border border-gray-700/50">
            <div class="flex items-center space-x-3 mb-3">
              <div class="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center">
                <svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-white">Collection</h3>
                <p class="text-sm text-gray-400">CRU-L1</p>
              </div>
            </div>
          </div>

          <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-6 border border-gray-700/50">
            <div class="flex items-center space-x-3 mb-3">
              <div class="w-10 h-10 bg-green-500/20 rounded-xl flex items-center justify-center">
                <svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-white">Status</h3>
                <p class="text-sm text-gray-400">Operational</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 animate-bounce">
      <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
      </svg>
    </div>
  </section>

  <nav class="sticky top-0 shadow-2xl z-50 border-b-2 border-opacity-40 backdrop-blur-xl" style="background: linear-gradient(135deg, rgba(31, 41, 55, 0.95) 0%, rgba(17, 24, 39, 0.95) 100%); border-color: #2c5278;">
    <div class="w-full mx-auto px-6" style="max-width: 80%; margin-left: auto; margin-right: auto;">
      <ul class="flex justify-between items-center py-1">
        <li class="flex-1">
          <a href="https://staff.medrunner.space" class="flex items-center hover:opacity-80 transition-opacity" title="Back to Medrunner Portal">
            <img src="medrunner-logo-stable-white.svg" class="h-10" alt="Medrunner Logo">
          </a>
        </li>

        <li class="flex-1 flex justify-center items-center space-x-2">
          <a href="#kits" class="nav-link px-6 py-3 font-semibold text-base transition-all duration-300 text-white hover:text-blue-300">
            <span class="flex items-center space-x-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"></path>
              </svg>
              <span>Equipment Kits</span>
            </span>
          </a>

          <div class="relative group">
            <button onclick="toggleItemsDropdown()" class="nav-link px-6 py-3 font-semibold text-base flex items-center transition-all duration-300 text-white hover:text-blue-300">
              <span class="flex items-center space-x-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"></path>
                </svg>
                <span>Individual Items</span>
                <svg class="ml-1 w-4 h-4 transition-transform duration-300 group-hover:rotate-180" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
              </span>
            </button>
            <div id="items-dropdown" class="absolute top-full left-0 rounded-2xl shadow-2xl mt-3 py-3 min-w-72 hidden z-50 border-2 border-opacity-40 backdrop-blur-xl" style="background: linear-gradient(135deg, rgba(29, 39, 53, 0.95) 0%, rgba(17, 24, 39, 0.95) 100%); border-color: #2c5278;">
              <a href="#armor" class="dropdown-link block px-6 py-4 font-medium transition-all duration-300 text-white hover:text-blue-300">
                <span class="flex items-center space-x-3">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                  </svg>
                  <span>Protective Gear</span>
                </span>
              </a>
              <a href="#items" class="dropdown-link block px-6 py-4 font-medium transition-all duration-300 text-white hover:text-blue-300">
                <span class="flex items-center space-x-3">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"></path>
                  </svg>
                  <span>Medical Tools</span>
                </span>
              </a>
              <a href="#equipment" class="dropdown-link block px-6 py-4 font-medium transition-all duration-300 text-white hover:text-blue-300">
                <span class="flex items-center space-x-3">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"></path>
                  </svg>
                  <span>General Equipment</span>
                </span>
              </a>
            </div>
          </div>

          <!-- Staff Control Link - Only visible for logistics staff -->
          <div id="staff-control-divider" class="h-8 w-px bg-gray-600 mx-2" style="display: none;"></div>

          <!-- My Orders Link - Only visible when logged in -->
          <a id="my-orders-link" href="my-orders.html" class="nav-link px-6 py-3 font-semibold text-base transition-all duration-300 text-white hover:text-blue-300" style="display: none;">
            <span class="flex items-center space-x-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm9 4a1 1 0 10-2 0v2H9a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V9z" clip-rule="evenodd"></path>
              </svg>
              <span>My Orders</span>
            </span>
          </a>

          <a id="staff-control-link" href="staff-control.html" class="nav-link px-6 py-3 font-semibold text-base transition-all duration-300 text-white hover:text-blue-300" style="display: none;">
            <span class="flex items-center space-x-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
              </svg>
              <span>Logistics Staff</span>
            </span>
          </a>
        </li>

        <li class="flex-1 flex justify-end items-center space-x-4">
          <!-- Cart button - Only visible when authenticated -->
          <button id="cart-button" onclick="toggleCart()" class="professional-button px-8 py-3 font-semibold text-base flex items-center space-x-3 shadow-lg" style="display: none;">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path>
            </svg>
            <span>Cart</span>
            <span class="bg-white/20 px-2 py-1 rounded-full text-sm font-bold" id="cart-count">0</span>
          </button>

          <!-- User info - Populated by medrunner-auth.js when authenticated -->
          <div id="nav-user-info" style="display: none;"></div>

          <!-- Login button - Visible when not authenticated -->
          <button id="login-prompt" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-4 py-2 rounded-lg font-semibold text-sm flex items-center space-x-2 shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 71 55">
              <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
            </svg>
            <span>Login with Discord</span>
          </button>
        </li>
      </ul>
    </div>
  </nav>

  <section id="individual-items" class="py-20 px-4" style="background-color: #1f2937;">
    <div class="w-full mx-auto" style="max-width: 80%; margin-left: auto; margin-right: auto;">
      <div class="section-header text-center mb-16">
        <h2 class="text-4xl font-bold mb-4" style="color: #ffffff;">The Logistics Equipment Catalog</h2>
        <p class="text-xl text-gray-300 font-light">Everything you could ever need</p>
      </div>

      <div id="equipment-loading" class="text-center py-20">
        <div class="inline-flex flex-col items-center space-y-6">
          <div class="relative">
            <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
              <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
              </svg>
            </div>
          </div>

          <div class="space-y-2">
            <h3 class="text-xl font-semibold text-white">Loading Inventory</h3>
            <p class="text-gray-400">Connecting to database...</p>
          </div>

          <div class="flex space-x-2">
            <div class="w-2 h-2 bg-blue-600 rounded-full animate-pulse"></div>
            <div class="w-2 h-2 bg-blue-600 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
            <div class="w-2 h-2 bg-blue-600 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
          </div>
        </div>
      </div>

      <div id="equipment-content" class="hidden">
        <div id="kits" class="mb-20">
          <div class="mb-8">
            <h3 class="text-3xl font-bold" style="color: #ffffff;">Kits</h3>
            <p class="text-gray-400 mt-2">Complete Equipment Packages. Click "Kit Info" for more</p>
          </div>
          <div id="kits-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6"></div>
        </div>

        <div id="armor" class="mb-20">
          <div class="mb-8">
            <h3 class="text-3xl font-bold" style="color: #ffffff;">Armor</h3>
            <p class="text-gray-400 mt-2">Personal Protective Equipment and Armor Components</p>
          </div>
          <div id="armor-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6"></div>
        </div>

        <div id="items" class="mb-20">
          <div class="mb-8">
            <h3 class="text-3xl font-bold" style="color: #ffffff;">Weapons</h3>
            <p class="text-gray-400 mt-2">Sponsered by Behring, all weapons are free of charge.</p>
          </div>
          <div id="items-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6"></div>
        </div>

        <div id="equipment" class="mb-20">
          <div class="mb-8">
            <h3 class="text-3xl font-bold" style="color: #ffffff;">Equipment</h3>
            <p class="text-gray-400 mt-2">Utilities and Equipment</p>
          </div>
          <div id="equipment-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6"></div>
        </div>

        <div id="ships" class="mb-20">
          <div class="mb-8">
            <h3 class="text-3xl font-bold" style="color: #ffffff;">Ships</h3>
          </div>
          <div id="ships-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6"></div>
        </div>

        <div id="ship-components" class="mb-20">
          <div class="mb-8">
            <h3 class="text-3xl font-bold" style="color: #ffffff;">Ship Components</h3>
          </div>
          <div id="ship-components-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6"></div>
        </div>
      </div>
    </div>
  </section>

  <footer class="border-t border-opacity-20 py-8 px-4" style="background-color: #1f2937; border-color: #2c5278;">
    <div class="w-full mx-auto" style="max-width: 80%; margin-left: auto; margin-right: auto;">
      <div class="flex justify-between items-center">
        <div class="text-gray-400 text-sm">
          ¬© 2955 Medrunner Services. All rights reserved &nbsp;&nbsp;
          <a href="https://www.medrunner.space/legal-information" class="text-blue-400 hover:text-blue-300 transition-colors">Privacy Policy</a>
        </div>
        <div class="text-gray-400 text-sm">
          Made by: <span class="text-blue-400">AngelicFluffy</span>
        </div>
      </div>
    </div>
  </footer>

  <!-- Image Modal -->
  <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <img id="modalImage" src="" class="max-h-[90%] max-w-[90%] rounded shadow-lg" />
  </div>

  <!-- Request Success Modal -->
  <div id="order-success-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="max-w-md w-full mx-4 rounded-3xl overflow-hidden shadow-2xl" style="background: linear-gradient(135deg, #1d2735 0%, #0f1419 100%); border: 1px solid rgba(44, 82, 120, 0.3);">
      <div class="p-8 text-center">
        <div class="mb-6">
          <div class="w-24 h-24 mx-auto mb-6 rounded-full flex items-center justify-center animate-pulse" style="background: linear-gradient(135deg, #2c5278 0%, #1e3a5f 100%);">
            <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
            </svg>
          </div>
        </div>

        <h2 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-blue-300 bg-clip-text text-transparent">Order Placed!</h2>

        <div id="modal-order-id" class="text-2xl font-bold text-white mb-6" style="color: #2c5278;">MR-123456</div>

        <div class="mb-8">
          <p class="text-gray-300 text-lg mb-4">We have received your request</p>
          <div id="modal-message" class="bg-gray-800/30 rounded-2xl p-6 text-sm text-gray-300 text-left border border-gray-700/50 backdrop-blur-sm"></div>
        </div>

        <div class="bg-blue-500/10 border border-blue-500/30 rounded-2xl p-4 mb-8 backdrop-blur-sm">
          <div class="flex items-start space-x-3">
            <svg class="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
            <div class="text-left">
              <p class="text-blue-300 font-semibold text-sm">Check Discord</p>
              <p class="text-blue-200/70 text-xs mt-1">You'll be added to a thread with your order details</p>
            </div>
          </div>
        </div>

        <button onclick="closeOrderModal()" class="w-full py-3 px-6 font-semibold text-white rounded-xl transition-all duration-300 hover:shadow-lg" style="background: linear-gradient(135deg, #2c5278 0%, #1e3a5f 100%); border: 1px solid rgba(44, 82, 120, 0.5);">
          Got it!
        </button>
      </div>
    </div>
  </div>

  <!-- Order Details Modal -->
  <div id="order-details-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-3xl shadow-2xl border border-gray-600/50 w-full max-w-4xl max-h-[90vh] overflow-hidden">
      <!-- Modal Header -->
      <div class="flex justify-between items-center p-6 border-b border-gray-600/50 bg-gradient-to-r from-blue-600/10 to-purple-600/10">
        <div>
          <h2 id="order-details-title" class="text-2xl font-bold text-white">Order Details</h2>
          <p id="order-details-subtitle" class="text-gray-400 text-sm mt-1"></p>
        </div>
        <button onclick="closeOrderDetailsModal()" class="text-gray-400 hover:text-white text-3xl font-light transition-colors hover:bg-gray-700/50 rounded-full w-10 h-10 flex items-center justify-center">&times;</button>
      </div>

      <!-- Modal Content -->
      <div class="p-6 overflow-y-auto max-h-[calc(90vh-180px)]">
        <!-- Order Info -->
        <div id="order-details-info" class="mb-6">
          <!-- Will be populated dynamically -->
        </div>

        <!-- Thread Messages -->
        <div class="border-t border-gray-700 pt-6">
          <h3 class="text-xl font-bold text-white mb-4 flex items-center">
            <svg class="w-5 h-5 mr-2 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
            </svg>
            Order Thread
          </h3>

          <!-- Messages Container -->
          <div id="thread-messages" class="space-y-4 mb-4 max-h-96 overflow-y-auto bg-gray-800/30 rounded-xl p-4 border border-gray-700/50">
            <div class="text-center text-gray-400 py-8">
              <svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
              </svg>
              <p>Loading messages...</p>
            </div>
          </div>

          <!-- Send Message Form -->
          <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700/50">
            <label class="block text-sm font-semibold text-gray-300 mb-2">Send a message to logistics staff:</label>
            <div class="flex space-x-2">
              <textarea id="thread-message-input" rows="2" placeholder="Type your message here..." class="flex-1 px-4 py-2 bg-gray-900/50 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
              <button onclick="sendThreadMessage()" class="px-6 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold rounded-lg transition-all duration-300 transform hover:scale-105 flex items-center space-x-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
                </svg>
                <span>Send</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Request Sidebar -->
  <div id="cart-sidebar" class="fixed top-0 right-0 h-full w-96 shadow-2xl transform translate-x-full transition-transform duration-300 z-50 overflow-y-auto border-l border-opacity-30 backdrop-blur-md" style="background-color: rgba(31, 41, 55, 0.95); border-color: #2c5278;">
    <div class="p-6">
      <div class="flex justify-between items-center mb-8 pb-4 border-b border-opacity-20" style="border-color: #2c5278;">
        <div class="flex items-center space-x-3">
          <svg class="w-6 h-6" style="color: #2c5278;" fill="currentColor" viewBox="0 0 20 20">
            <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path>
          </svg>
          <h2 class="text-2xl font-bold" style="color: #2c5278;">Equipment Request</h2>
        </div>
        <button onclick="toggleCart()" class="text-gray-400 hover:text-white text-3xl transition-colors duration-300 hover:bg-gray-700 rounded-lg p-2">&times;</button>
      </div>

      <div id="cart-items-sidebar" class="space-y-4 mb-6"></div>

      <div class="border-t border-opacity-20 pt-8 mb-8" style="border-color: #2c5278;">
        <h3 class="text-xl font-bold mb-6 flex items-center" style="color: #2c5278;">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"></path>
          </svg>
          Contact Details
        </h3>

        <div class="space-y-6">
          <div>
            <label class="block text-sm font-semibold mb-3 text-gray-300">Discord Username *</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <input type="text" id="discord-username" placeholder="YourDiscordUsername"
                     class="w-full text-white pl-12 pr-4 py-4 rounded-xl border border-opacity-30 focus:border-opacity-100 focus:ring-2 focus:ring-blue-500/20 transition-all duration-300 font-medium focus:outline-none shadow-lg" style="background-color: #1d2735; border-color: #2c5278;">
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-4 text-gray-300">Collection Location</label>
            <div class="p-4 rounded-xl border border-opacity-20" style="border-color: #2c5278; background-color: #1d2735;">
              <div class="flex items-center">
                <span class="text-2xl mr-3">üìç</span>
                <div>
                  <p class="font-semibold text-white">CRU-L1</p>
                  <p class="text-sm text-gray-400">All equipment is collected from the muster point</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="professional-card p-6 mb-6">
        <h3 class="text-xl font-bold mb-6 flex items-center" style="color: #2c5278;">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Request Details
        </h3>
        <div id="request-details-content" class="space-y-3">
          <p class="text-gray-400 text-sm">Your requested equipment</p>
        </div>
      </div>

      <div class="professional-card p-6 mb-6">
        <h3 class="text-xl font-bold mb-4 flex items-center" style="color: #2c5278;">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
          </svg>
          Collection Availability *
        </h3>
        <p class="text-gray-400 text-sm mb-6">Select at least 2 time slots when you're available for collection (your local time)</p>

        <div id="availability-slots" class="space-y-4">
          <!-- Availability slot generation -->
        </div>

        <button onclick="addAvailabilitySlot()" class="mt-4 w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-all duration-300 flex items-center justify-center">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
          </svg>
          Add Time Slot
        </button>
      </div>

      <div class="text-center mb-6">
        <div class="bg-blue-500/10 rounded-xl p-4 mb-6 border border-blue-500/20">
          <p class="text-sm text-blue-300 font-medium mb-2">Ready to submit request?</p>
          <p class="text-xs text-gray-400">Complete your details above and submit your request</p>
        </div>

        <button onclick="checkout()" class="professional-button w-full py-4 text-lg font-bold rounded-xl flex items-center justify-center space-x-3 shadow-xl">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path>
          </svg>
          <span>Submit Request</span>
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>

        <p class="text-xs text-gray-400 mt-4 leading-relaxed">
          Your request will be sent to logistics for processing<br>
          üìç All equipment can be collected from CRU-L1
        </p>

        <div id="sheets-status" class="mt-4 text-xs text-center hidden">
          <span id="sheets-status-text" class="px-3 py-2 rounded-lg"></span>
        </div>
      </div>
    </div>
  </div>

  <div id="cart-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40" onclick="toggleCart()"></div>

  <!-- Toast Notification -->
  <div id="toast-notification" class="fixed top-6 right-6 px-6 py-4 rounded-xl shadow-2xl transform translate-x-full opacity-0 transition-all duration-300 z-50 backdrop-blur-md border border-opacity-30 max-w-sm" style="background-color: #2c5278; color: #ffffff; border-color: #1e3a5f;">
    <div class="flex items-center space-x-3">
      <div class="flex-shrink-0">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
        </svg>
      </div>
      <span id="toast-message" class="font-semibold">Item added to request!</span>
    </div>
  </div>

  <script>
    const categoryGrids = {
      'Kit': { grid: document.getElementById('kits-grid'), section: document.getElementById('kits') },
      'Weapon': { grid: document.getElementById('items-grid'), section: document.getElementById('items') },
      'Armor': { grid: document.getElementById('armor-grid'), section: document.getElementById('armor') }, // American spelling from spreadsheet
      'Armour': { grid: document.getElementById('armor-grid'), section: document.getElementById('armor') }, // British spelling fallback
      'Amor': { grid: document.getElementById('armor-grid'), section: document.getElementById('armor') }, // Typos
      'Equipment': { grid: document.getElementById('equipment-grid'), section: document.getElementById('equipment') },
      'Ship': { grid: document.getElementById('ships-grid'), section: document.getElementById('ships') },
      'Ammo': { grid: document.getElementById('items-grid'), section: document.getElementById('items') },
      'Ship Component': { grid: document.getElementById('ship-components-grid'), section: document.getElementById('ship-components') },
      'Sustenance': { grid: document.getElementById('equipment-grid'), section: document.getElementById('equipment') }
    };

    function showLoadingScreen() {
      const loadingElement = document.getElementById('equipment-loading');
      const contentElement = document.getElementById('equipment-content');

      if (loadingElement) loadingElement.classList.remove('hidden');
      if (contentElement) contentElement.classList.add('hidden');
    }

    function hideLoadingScreen() {
      const loadingElement = document.getElementById('equipment-loading');
      const contentElement = document.getElementById('equipment-content');

      if (loadingElement) loadingElement.classList.add('hidden');
      if (contentElement) contentElement.classList.remove('hidden');
    }

    // THIS IS A TOGGLE: Set to false to hide restricted items from users without access
    const SHOW_ALL_ITEMS_FOR_DEMO = true;

    // Check if user can see a restricted item based on their roles
    function canUserSeeItem(item) {
      // If demo mode is enabled, show all items
      if (SHOW_ALL_ITEMS_FOR_DEMO) {
        return true;
      }

      // If item has no restriction or restriction is "none", everyone can see it
      if (!item.restriction || item.restriction.trim() === '' || item.restriction.trim().toLowerCase() === 'none') {
        return true;
      }

      // Get current user
      const user = window.MEDRUNNER_AUTH ? window.MEDRUNNER_AUTH.getUser() : null;
      if (!user) {
        // Not authenticated - hide restricted items
        return false;
      }

      const restriction = item.restriction.trim().toLowerCase();

      // Check if user has the required role
      if (restriction === 'academy') {
        return user.isAcademyStaff || user.roles?.includes('academy');
      } else if (restriction === 'logistics') {
        return user.isLogisticsStaff || user.roles?.includes('logistics');
      } else if (restriction === 'staff') {
        return user.isStaff;
      }

      // Weapon restrictions - show to everyone but they need certification
      if (restriction.includes('weapon')) {
        return true;
      }

      // Unknown restriction type - hide by default
      return false;
    }

    // Check if user has access to a restricted item (for banner display)
    function userHasAccessToItem(item) {
      // If item has no restriction or restriction is "none", everyone has access
      if (!item.restriction || item.restriction.trim() === '' || item.restriction.trim().toLowerCase() === 'none') {
        return true;
      }

      // Get current user
      const user = window.MEDRUNNER_AUTH ? window.MEDRUNNER_AUTH.getUser() : null;
      if (!user) {
        return false;
      }

      const restriction = item.restriction.trim().toLowerCase();

      // Check if user has the required role
      if (restriction === 'academy') {
        return user.isAcademyStaff || user.roles?.includes('academy');
      } else if (restriction === 'logistics') {
        return user.isLogisticsStaff || user.roles?.includes('logistics');
      } else if (restriction === 'staff') {
        return user.isStaff;
      }

      // Weapon restrictions - user needs certification (assume they don't have it)
      if (restriction.includes('weapon')) {
        return false;
      }

      return false;
    }

    function renderInventoryItems() {
      showLoadingScreen();

      Object.values(categoryGrids).forEach(categoryObj => {
        if (categoryObj && categoryObj.grid) {
          categoryObj.grid.innerHTML = '';
          if (categoryObj.section) {
            categoryObj.section.classList.add('hidden');
          }
        }
      });

      if (!window.inventoryData) {
        return;
      }

      const itemsByCategory = {};

      Object.values(window.inventoryData).forEach(item => {
        // Filter items based on user's roles
        if (!canUserSeeItem(item)) {
          return; // Skip this item
        }

        const category = item.category || 'Equipment';
        if (!itemsByCategory[category]) {
            itemsByCategory[category] = [];
          }
          itemsByCategory[category].push(item);
      });

      Object.entries(itemsByCategory).forEach(([category, items]) => {
        const categoryObj = categoryGrids[category];
        if (!categoryObj || !categoryObj.grid) {
          console.warn(`No grid found for category: ${category}`);
          return;
        }

        const targetGrid = categoryObj.grid;

        if (items.length > 0 && categoryObj.section) {
          categoryObj.section.classList.remove('hidden');
        }

        items.forEach(item => {
          const card = document.createElement('div');
          card.className = "equipment-card rounded-3xl overflow-hidden shadow-2xl border-2 hover:shadow-blue-500/10 flex flex-col h-full";

            card.innerHTML = `
              <div class="relative group overflow-hidden">
                <div class="relative">
                  <img src="${item.image || 'Placeholder.png'}"
                       alt="${item.name}"
                       class="w-full h-48 object-cover cursor-pointer transition-transform duration-300 group-hover:scale-105"
                       onerror="this.onerror=null; this.src='Placeholder.png';"
                       onclick="openImageModal('${item.image || 'Placeholder.png'}', '${item.name}')">

                  <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>

                  <div class="absolute bottom-3 left-3 z-10">
                    <span
                      class="inline-block px-3 py-1 text-white text-xs font-bold uppercase tracking-wide rounded-full shadow-lg" style="background-color: rgba(0, 0, 0, 0.2);backdrop-filter: blur(10px);">
                      ${category}
                    </span>
                  </div>

                  ${item.restriction && item.restriction.trim() !== '' && item.restriction.trim().toLowerCase() !== 'none' ?
                    (() => {
                      const restrictionType = item.restriction.trim().toLowerCase();
                      const hasAccess = userHasAccessToItem(item);
                      let bgColor = 'bg-blue-600'; // Default blue
                      let bannerText = item.restriction;
                      let icon = `<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                      </svg>`;

                      // Check if it's a weapon restriction
                      if (restrictionType.includes('weapon')) {
                        bgColor = 'bg-yellow-600'; // Yellow-orange for weapons
                        bannerText = 'CERTIFICATION REQUIRED';
                        icon = `<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>`;
                      } else if (hasAccess) {
                        // User has access - show blue banner with "ACCESS"
                        bgColor = 'bg-blue-600';
                        bannerText = item.restriction + ' ACCESS';
                      } else {
                        // User doesn't have access - show RED banner with "RESTRICTION"
                        bgColor = 'bg-red-600';
                        bannerText = item.restriction + ' RESTRICTION';
                        icon = `<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"></path>
                        </svg>`;
                      }

                      return `<div class="absolute bottom-0 left-0 right-0 ${bgColor} text-white px-3 py-1.5 text-xs font-bold shadow-lg z-20">
                        <div class="flex items-center justify-center space-x-1.5">
                          ${icon}
                          <span class="uppercase tracking-wide text-xs">${bannerText}</span>
                        </div>
                      </div>`;
                    })() : ''
                  }
                </div>

                <div class="p-5 bg-gradient-to-b from-gray-800/95 to-gray-900/95">
                  <h3 class="text-lg font-bold text-white mb-2 line-clamp-2">${item.name}</h3>

                  ${item.description ?
                    `<p class="text-gray-400 text-sm mb-4 line-clamp-3">${item.description}</p>` :
                    `<div class="mb-4"></div>`
                  }

                  ${item.requiredMissions && parseInt(item.requiredMissions) > 0 ?
                    `<div class="mb-4 p-3 bg-amber-500/15 border-l-4 border-amber-500 rounded-r-lg">
                      <div class="flex items-center space-x-2 text-amber-300 text-sm font-medium">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        <span>Requires ${item.requiredMissions} Completed Missions</span>
                      </div>
                    </div>` : ''
                  }

                  <div class="space-y-3">
                    <div class="flex items-center justify-between bg-gray-700/50 rounded-lg px-4 py-3 border border-gray-600/50">
                      <label class="text-sm font-medium text-gray-300">Quantity</label>
                      <input type="number"
                             id="quantity-${item.name.replace(/\s+/g, '-')}"
                             min="1"
                             max="${(() => {
                               const category = item.category.toLowerCase();
                               if (category === 'kit' || category === 'ship' || category === 'ship component') return '1';
                               return '5';
                             })()}"
                             value="1"
                             class="quantity-input w-20 px-3 py-1 bg-gray-800 border border-gray-600 rounded-lg text-white text-center focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20">
                    </div>

                    ${(() => {
                      const hasAccess = userHasAccessToItem(item);
                      const isRestricted = item.restriction && item.restriction.trim() !== '' && item.restriction.trim().toLowerCase() !== 'none';
                      const isWeapon = isRestricted && item.restriction.trim().toLowerCase().includes('weapon');
                      const disabled = isRestricted && !hasAccess;
                      const disabledAttr = disabled ? 'disabled' : '';
                      const buttonClass = disabled ? 'bg-red-600 hover:bg-red-700 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700';
                      const restrictionText = isWeapon ? 'Certification Required' : (isRestricted ? `${item.restriction} Restriction` : '');
                      const titleAttr = disabled ? `title="‚õî ${restrictionText} - You do not have access to requisition this item"` : '';

                      if (item.category && item.category.toLowerCase() === 'kit') {
                        return `<div class="grid grid-cols-2 gap-2">
                          <button onclick="showKitInformation('${item.name.replace(/'/g, "\\'")}')"
                                  class="bg-blue-600 hover:bg-blue-700 text-white py-2.5 px-3 font-semibold text-xs rounded-lg transition-all duration-200 flex items-center justify-center space-x-1.5 hover:shadow-lg">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd"></path>
                            </svg>
                            <span>Kit Info</span>
                          </button>
                          <button onclick="addToCart('${item.name.replace(/'/g, "\\'")}', '${item.name.replace(/'/g, "\\'")}', this)"
                                  class="${buttonClass} text-white py-2.5 px-3 font-semibold text-xs rounded-lg transition-all duration-200 flex items-center justify-center space-x-1.5 hover:shadow-lg disabled:opacity-75 disabled:cursor-not-allowed"
                                  id="btn-${item.name.replace(/\s+/g, '-')}"
                                  ${disabledAttr}
                                  ${titleAttr}
                                  data-item-name="${item.name.replace(/"/g, '&quot;')}"
                                  data-has-access="${hasAccess}">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                              <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"></path>
                            </svg>
                            <span>Requisition</span>
                          </button>
                        </div>`;
                      } else {
                        return `<button onclick="addToCart('${item.name.replace(/'/g, "\\'")}', '${item.name.replace(/'/g, "\\'")}', this)"
                                class="w-full ${buttonClass} text-white py-3 px-4 font-semibold text-sm rounded-lg transition-all duration-200 flex items-center justify-center space-x-2 hover:shadow-lg disabled:opacity-75 disabled:cursor-not-allowed"
                                id="btn-${item.name.replace(/\s+/g, '-')}"
                                ${disabledAttr}
                                ${titleAttr}
                                data-item-name="${item.name.replace(/"/g, '&quot;')}"
                                data-has-access="${hasAccess}">
                          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"></path>
                          </svg>
                          <span>Requisition</span>
                        </button>`;
                      }
                    })()}
                  </div>
                </div>
              </div>
            `;

            targetGrid.appendChild(card);
          });
      });

      hideLoadingScreen();
    }

    async function showKitInformation(kitName) {
      try {
        // Check if kit data is in cache
        if (window.kitDataCache && window.kitDataCache[kitName]) {
          showKitInfoModal(kitName, window.kitDataCache[kitName]);
          return;
        }

        // If not in cache, fetch it (fallback)
        if (!window.MEDRUNNER_CONFIG || !window.MEDRUNNER_CONFIG.APPS_SCRIPT_URL) {
          throw new Error('Medrunner configuration not loaded');
        }

        // Use JSONP with retry to bypass CORS
        const data = await fetchWithRetry(window.MEDRUNNER_CONFIG.APPS_SCRIPT_URL, {
          action: 'getKitInfo',
          kitName: kitName
        });

        if (!data || !data.success) {
          throw new Error('Kit information not found: ' + (data.message || 'Unknown error'));
        }

        // Cache it for next time
        window.kitDataCache[kitName] = data.data;

        showKitInfoModal(kitName, data.data);

      } catch (error) {
        console.error('‚ùå Error fetching kit information:', error);
        showToast('Kit information not available', 'error');
      }
    }

    function showKitInfoModal(kitName, kitData) {
      let modal = document.getElementById('kitInfoModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'kitInfoModal';
        modal.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4';
        modal.innerHTML = `
          <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-3xl shadow-2xl border border-gray-600/50 w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-gray-600/50 bg-gradient-to-r from-blue-600/10 to-purple-600/10">
              <h2 id="kitInfoTitle" class="text-2xl font-bold text-white"></h2>
              <button onclick="closeKitInfoModal()" class="text-gray-400 hover:text-white text-3xl font-light transition-colors hover:bg-gray-700/50 rounded-full w-10 h-10 flex items-center justify-center">&times;</button>
            </div>
            <div id="kitInfoContent" class="p-6 overflow-y-auto max-h-[calc(90vh-120px)] text-gray-300"></div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      document.getElementById('kitInfoTitle').textContent = kitData.name || kitName;

      let content = '';

      if (kitData.sections && kitData.sections.length > 0) {
        content += `<div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">`;

        kitData.sections.forEach(section => {
          if (section.items && section.items.length > 0) {
            content += `
              <div class="bg-gradient-to-br from-gray-800/80 to-gray-700/60 rounded-2xl p-4 border border-gray-600/30 shadow-lg">
                <h3 class="text-lg font-bold text-white mb-3 pb-2 border-b border-gray-500/30 bg-gradient-to-r from-blue-500/20 to-purple-500/20 -m-4 mb-3 p-4 rounded-t-2xl">${section.name}</h3>
                <div class="space-y-1.5">
            `;

            section.items.forEach(item => {
              content += `
                <div class="flex justify-between items-center py-1.5 px-2 bg-gray-900/40 rounded-lg text-sm">
                  <span class="text-gray-200 font-medium truncate pr-2">${item.name}</span>
                  <span class="text-blue-400 font-bold text-xs bg-blue-500/20 px-2 py-1 rounded-full flex-shrink-0">${item.quantity}</span>
                </div>
              `;
            });

            content += `
                </div>
              </div>
            `;
          }
        });

        content += `</div>`;
      }

      document.getElementById('kitInfoContent').innerHTML = content || '<p>No additional information available for this kit.</p>';

      modal.classList.remove('hidden');
    }

    function closeKitInfoModal() {
      const modal = document.getElementById('kitInfoModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    document.addEventListener('click', function(event) {
      const modal = document.getElementById('kitInfoModal');
      if (modal && event.target === modal) {
        closeKitInfoModal();
      }
    });

    </script>

  <script>
    window.inventoryData = null;
    window.lastInventoryUpdate = null;
    window.kitDataCache = {}; // Cache for kit information

    async function fetchInventoryData() {
      try {
        if (!window.MEDRUNNER_CONFIG || !window.MEDRUNNER_CONFIG.APPS_SCRIPT_URL) {
          throw new Error('Medrunner configuration not loaded');
        }

        if (!window.MedrunnerConfig.isConfigured()) {
          throw new Error('Medrunner configuration not set up. Please update medrunner-config.js');
        }

        console.log('üì° Fetching inventory data...');
        // Use JSONP with retry to bypass CORS
        const data = await fetchWithRetry(window.MEDRUNNER_CONFIG.APPS_SCRIPT_URL, { action: 'getInventory' });

        if (!data || !data.success) {
          throw new Error('Apps Script returned error: ' + (data.message || 'Unknown error'));
        }

        console.log('‚úÖ Inventory data loaded:', Object.keys(data.data.inventory).length, 'items');
        window.inventoryData = data.data.inventory;
        window.lastInventoryUpdate = new Date();

        // Pre-fetch all kit information for instant display
        await cacheAllKitData();

        return data.data.inventory;

      } catch (error) {
        console.error('‚ùå Error fetching inventory data:', error);
        showToast('Failed to load inventory from system', 'error');
        return null;
      }
    }

    // JSONP helper function to bypass CORS
    function fetchWithJSONP(url, params = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.random().toString(36).substr(2, 9);
        const timeoutId = setTimeout(() => {
          cleanup();
          reject(new Error('JSONP request timeout'));
        }, 30000); // 30 second timeout

        function cleanup() {
          clearTimeout(timeoutId);
          if (window[callbackName]) {
            delete window[callbackName];
          }
          if (script && script.parentNode) {
            script.parentNode.removeChild(script);
          }
        }

        window[callbackName] = function(data) {
          cleanup();
          resolve(data);
        };

        const script = document.createElement('script');
        const queryParams = new URLSearchParams(params);
        queryParams.append('callback', callbackName);
        script.src = `${url}?${queryParams.toString()}`;

        script.onerror = function(error) {
          cleanup();
          console.error('JSONP script error:', error);
          console.error('Script URL was:', script.src);
          reject(new Error('JSONP request failed - check console for details'));
        };

        script.onload = function() {
          console.log('‚úÖ JSONP script loaded successfully');
        };

        document.body.appendChild(script);
      });
    }

    // Fallback fetch with retry logic
    async function fetchWithRetry(url, params = {}, maxRetries = 2) {
      // First try JSONP
      for (let i = 0; i < maxRetries; i++) {
        try {
          console.log(`Attempting JSONP request (attempt ${i + 1}/${maxRetries})...`);
          const result = await fetchWithJSONP(url, params);
          console.log('‚úÖ JSONP request successful');
          return result;
        } catch (error) {
          console.warn(`JSONP attempt ${i + 1} failed:`, error.message);
          if (i === maxRetries - 1) {
            // Last attempt - try regular fetch as fallback
            try {
              console.log('Trying regular fetch as fallback...');
              const queryParams = new URLSearchParams(params);
              const response = await fetch(`${url}?${queryParams.toString()}`);
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              const data = await response.json();
              console.log('‚úÖ Regular fetch successful');
              return data;
            } catch (fetchError) {
              console.error('Regular fetch also failed:', fetchError);
              throw new Error(`All request methods failed. JSONP: ${error.message}, Fetch: ${fetchError.message}`);
            }
          }
          // Wait before retry
          await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        }
      }
    }

    // Pre-fetch all kit information and cache it
    async function cacheAllKitData() {
      if (!window.inventoryData) return;

      // Find all kit items
      const kitItems = Object.values(window.inventoryData).filter(item =>
        item.category && item.category.toLowerCase() === 'kit'
      );

      // Fetch kit data for all kits in parallel
      const fetchPromises = kitItems.map(async (kit) => {
        try {
          // Use JSONP with retry to bypass CORS
          const data = await fetchWithRetry(window.MEDRUNNER_CONFIG.APPS_SCRIPT_URL, {
            action: 'getKitInfo',
            kitName: kit.name
          });

          if (data && data.success && data.data) {
            window.kitDataCache[kit.name] = data.data;
          }
        } catch (error) {
          console.warn(`‚ö†Ô∏è Failed to cache kit ${kit.name}:`, error);
        }
      });

      // Wait for all kit data to be fetched
      await Promise.all(fetchPromises);
    }

    function formatPrice(price) {
      if (!price || price === 0) {
        return 'Contact for Price';
      }
      return `${price.toLocaleString()} aUEC`;
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast-notification');
      const messageElement = document.getElementById('toast-message');

      if (toast && messageElement) {
        messageElement.textContent = message;

        if (type === 'error') {
          toast.style.backgroundColor = '#aa0000';
          toast.style.color = 'white';
        } else {
          toast.style.backgroundColor = '#2c5278';
          toast.style.color = '#ffffff';
        }

        toast.style.transform = 'translateX(0)';
        toast.style.opacity = '1';
        setTimeout(() => {
          toast.style.transform = 'translateX(100%)';
          toast.style.opacity = '0';
        }, 3000);
      }
    }

    function validateCartStock() {
      return [];
    }
    function fixCartStockIssues() {
      return false;
    }

    document.addEventListener('DOMContentLoaded', async function() {
      // Setup login button click handler
      const loginButton = document.getElementById('login-prompt');
      if (loginButton) {
        loginButton.addEventListener('click', () => {
          if (window.MEDRUNNER_AUTH && window.MEDRUNNER_AUTH.loginWithDiscord) {
            window.MEDRUNNER_AUTH.loginWithDiscord();
          } else {
            console.error('‚ùå MEDRUNNER_AUTH not available');
            alert('Authentication system not loaded. Please refresh the page.');
          }
        });
      } else {
        console.warn('‚ö†Ô∏è Login button not found');
      }

      showLoadingScreen();
      const loadingTimeout = setTimeout(() => {
        console.warn('Loading timeout reached, hiding loading screen');
        hideLoadingScreen();
      }, 10000);

      try {
        await fetchInventoryData();
        clearTimeout(loadingTimeout);
      } catch (error) {
        console.warn('Could not load inventory data:', error.message);
        clearTimeout(loadingTimeout);
        hideLoadingScreen();
      }

      renderInventoryItems();
      setInterval(async () => {
        try {
          await fetchInventoryData();
          renderInventoryItems();
        } catch (error) {
          console.warn('Could not refresh inventory data:', error.message);
        }
      }, 5 * 60 * 1000);

      generateAvailabilitySlots();
    });

    // Listen for authentication events to auto-fill Discord username and show/hide UI elements
    window.addEventListener('medrunnerAuthReady', (event) => {
      const user = event.detail.user;
      const discordUsernameField = document.getElementById('discord-username');

      if (user && user.discordUsername && discordUsernameField) {
        // Auto-fill Discord username
        discordUsernameField.value = user.discordUsername;
        discordUsernameField.readOnly = true;
        discordUsernameField.style.backgroundColor = '#1a2332';
        discordUsernameField.style.cursor = 'not-allowed';
      }

      // Show cart button, hide login prompt
      const cartButton = document.getElementById('cart-button');
      const loginPrompt = document.getElementById('login-prompt');
      if (cartButton) cartButton.style.display = 'flex';
      if (loginPrompt) loginPrompt.style.display = 'none';

      // Show My Orders link when logged in
      const myOrdersLink = document.getElementById('my-orders-link');
      if (myOrdersLink) myOrdersLink.style.display = 'block';

      // Show staff control link if user is logistics staff
      if (user && user.isLogisticsStaff) {
        const staffLink = document.getElementById('staff-control-link');
        const staffDivider = document.getElementById('staff-control-divider');
        if (staffLink) staffLink.style.display = 'block';
        if (staffDivider) staffDivider.style.display = 'block';
      }

      // Re-render inventory to show/hide restricted items based on user's roles
      if (window.inventoryData) {
        renderInventoryItems();
      }
    });

    // Listen for authentication updates (role changes)
    window.addEventListener('medrunnerAuthUpdated', (event) => {
      const user = event.detail.user;

      // Re-render inventory to show/hide restricted items
      if (window.inventoryData) {
        renderInventoryItems();
      }

      // Update My Orders link visibility
      const myOrdersLink = document.getElementById('my-orders-link');
      if (user && user.discordId) {
        if (myOrdersLink) myOrdersLink.style.display = 'block';
      } else {
        if (myOrdersLink) myOrdersLink.style.display = 'none';
      }

      // Update staff control link visibility
      const staffLink = document.getElementById('staff-control-link');
      const staffDivider = document.getElementById('staff-control-divider');
      if (user && user.isLogisticsStaff) {
        if (staffLink) staffLink.style.display = 'block';
        if (staffDivider) staffDivider.style.display = 'block';
      } else {
        if (staffLink) staffLink.style.display = 'none';
        if (staffDivider) staffDivider.style.display = 'none';
      }
    });

    window.inventoryDataLoaded = false;

    function generateTimeSlots() {
      const slots = [];
      for (let hour = 0; hour < 24; hour++) {
        for (let minute = 0; minute < 60; minute += 15) {
          const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
          slots.push(timeStr);
        }
      }
      return slots;
    }

    // Track availability slots
    let availabilitySlotCount = 0;
    const MAX_AVAILABILITY_SLOTS = 5;

    function generateAvailabilitySlots() {
      const container = document.getElementById('availability-slots');
      if (!container) return;

      // Add 2 initial slots
      addAvailabilitySlot();
      addAvailabilitySlot();
    }

    function addAvailabilitySlot() {
      const container = document.getElementById('availability-slots');
      if (!container) return;

      if (availabilitySlotCount >= MAX_AVAILABILITY_SLOTS) {
        showToast(`We probably won't need more than ${MAX_AVAILABILITY_SLOTS} time slots to reach you!`, 'info');
        return;
      }

      const slotIndex = availabilitySlotCount;
      const timeSlots = generateTimeSlots();
      const today = new Date();

      // Generate date options for next 7 days
      let dateOptions = '';
      for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() + i);
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const dateValue = date.toISOString().split('T')[0];
        dateOptions += `<option value="${dateValue}">${dayName}, ${dateStr}</option>`;
      }

      const slotHTML = `
        <div id="availability-slot-${slotIndex}" class="border border-gray-700 rounded-xl p-4 bg-gray-800/30">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center">
              <svg class="w-5 h-5 mr-2 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
              </svg>
              <span class="text-white font-semibold">Time Slot ${slotIndex + 1}</span>
            </div>
            ${slotIndex >= 2 ? `
              <button onclick="removeAvailabilitySlot(${slotIndex})" class="text-red-400 hover:text-red-300 transition-colors">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
              </button>
            ` : ''}
          </div>

          <div class="space-y-3">
            <div>
              <label class="block text-xs text-gray-400 mb-2">Date</label>
              <select id="availability-date-${slotIndex}" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:border-blue-500 focus:outline-none">
                ${dateOptions}
              </select>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs text-gray-400 mb-2">From Time</label>
                <select id="availability-from-${slotIndex}" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:border-blue-500 focus:outline-none" onchange="validateAvailabilitySlot(${slotIndex})">
                  <option value="">Select time</option>
                  <option value="all-day">All Day</option>
                  ${timeSlots.map(time => `<option value="${time}">${time}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="block text-xs text-gray-400 mb-2">To Time</label>
                <select id="availability-to-${slotIndex}" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:border-blue-500 focus:outline-none" onchange="validateAvailabilitySlot(${slotIndex})">
                  <option value="">Select time</option>
                  <option value="all-day">All Day</option>
                  ${timeSlots.map(time => `<option value="${time}">${time}</option>`).join('')}
                </select>
              </div>
            </div>
          </div>
        </div>
      `;

      container.insertAdjacentHTML('beforeend', slotHTML);
      availabilitySlotCount++;

      // Add event listener for "All Day" selection
      const fromSelect = document.getElementById(`availability-from-${slotIndex}`);
      const toSelect = document.getElementById(`availability-to-${slotIndex}`);

      if (fromSelect && toSelect) {
        fromSelect.addEventListener('change', function() {
          if (this.value === 'all-day') {
            toSelect.value = 'all-day';
            toSelect.disabled = true;
          } else {
            toSelect.disabled = false;
          }
        });
      }
    }

    function removeAvailabilitySlot(slotIndex) {
      const slotElement = document.getElementById(`availability-slot-${slotIndex}`);
      if (slotElement) {
        slotElement.remove();
      }
    }

    function validateAvailabilitySlot(slotIndex) {
      const fromSelect = document.getElementById(`availability-from-${slotIndex}`);
      const toSelect = document.getElementById(`availability-to-${slotIndex}`);

      if (!fromSelect || !toSelect) return true;

      const fromValue = fromSelect.value;
      const toValue = toSelect.value;

      // If "All Day" is selected, both should be "all-day"
      if (fromValue === 'all-day' || toValue === 'all-day') {
        return true;
      }

      // If both are selected, validate that "to" is after "from"
      if (fromValue && toValue) {
        const fromTime = new Date(`2000-01-01 ${fromValue}`);
        const toTime = new Date(`2000-01-01 ${toValue}`);

        if (toTime <= fromTime) {
          showToast('End time must be after start time', 'error');
          toSelect.value = '';
          return false;
        }
      }

      return true;
    }



    function getAvailabilityData() {
      const availabilityRanges = [];
      let validSlotCount = 0;

      // Loop through all availability slots
      for (let slotIndex = 0; slotIndex < availabilitySlotCount; slotIndex++) {
        const dateSelect = document.getElementById(`availability-date-${slotIndex}`);
        const fromSelect = document.getElementById(`availability-from-${slotIndex}`);
        const toSelect = document.getElementById(`availability-to-${slotIndex}`);

        // Check if slot still exists (not removed)
        if (!dateSelect || !fromSelect || !toSelect) continue;

        const dateValue = dateSelect.value;
        const fromValue = fromSelect.value;
        const toValue = toSelect.value;

        // Skip if not filled out
        if (!dateValue || !fromValue || !toValue) continue;

        validSlotCount++;

        // Handle "All Day" selection
        if (fromValue === 'all-day' && toValue === 'all-day') {
          const date = new Date(dateValue);
          const fromDate = new Date(date);
          fromDate.setHours(0, 0, 0, 0);
          const toDate = new Date(date);
          toDate.setHours(23, 59, 59, 999);

          const fromUnix = Math.floor(fromDate.getTime() / 1000);
          const toUnix = Math.floor(toDate.getTime() / 1000);

          availabilityRanges.push(`${fromUnix}-${toUnix}`);
        } else {
          // Handle specific time range
          const date = new Date(dateValue);
          const [fromHour, fromMinute] = fromValue.split(':').map(Number);
          const fromDate = new Date(date);
          fromDate.setHours(fromHour, fromMinute, 0, 0);

          const [toHour, toMinute] = toValue.split(':').map(Number);
          const toDate = new Date(date);
          toDate.setHours(toHour, toMinute, 0, 0);

          const fromUnix = Math.floor(fromDate.getTime() / 1000);
          const toUnix = Math.floor(toDate.getTime() / 1000);

          availabilityRanges.push(`${fromUnix}-${toUnix}`);
        }
      }

      return {
        ranges: availabilityRanges.join(', '),
        count: validSlotCount
      };
    }

    function openImage(src) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      modalImg.src = src;
      modal.classList.remove('hidden');
    }

    function openImageModal(src, alt) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      modalImg.src = src;
      modalImg.alt = alt;
      modal.classList.remove('hidden');
    }

    document.getElementById('imageModal').addEventListener('click', () => {
      document.getElementById('imageModal').classList.add('hidden');
    });

    let cart = [];
    let orderProcessing = false;

    function updateCartCount() {
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      const cartCountElement = document.getElementById('cart-count');
      const heroCartCountElement = document.getElementById('hero-cart-count');

      if (cartCountElement) {
        cartCountElement.textContent = totalItems;
      }
      if (heroCartCountElement) {
        heroCartCountElement.textContent = totalItems;
      }
    }

    function updateButtonState(button, itemName) {
      const card = button.closest('.equipment-card');
      const quantityInput = card.querySelector('.quantity-input');
      if (!quantityInput) return;
      const maxQuantity = parseInt(quantityInput.max);
      const sanitizedItemName = sanitizeInput(itemName);
      const existingItem = cart.find(item => item.name === sanitizedItemName);
      if (maxQuantity === 1 && existingItem) {
        button.disabled = true;
        button.title = 'Already in cart (max 1 per order)';
      } else {
        button.disabled = false;
        button.title = '';
      }
    }

    function addToCart(name, fullName, button) {
      // Check if user is authenticated
      if (!window.MEDRUNNER_AUTH || !window.MEDRUNNER_AUTH.isAuthenticated) {
        showToast('Please login with Discord to add items to cart', 'error');
        // Trigger login
        if (window.MEDRUNNER_AUTH && window.MEDRUNNER_AUTH.loginWithDiscord) {
          window.MEDRUNNER_AUTH.loginWithDiscord();
        }
        return;
      }

      const card = button.closest('.equipment-card');
      const quantityInput = card.querySelector('.quantity-input');

      if (!quantityInput) {
        console.error('‚ùå Could not find quantity input for:', name);
        return;
      }

      // Check if user has access to this item
      const inventoryItem = Object.values(window.inventoryData || {}).find(item => item.name === name);
      if (inventoryItem && !userHasAccessToItem(inventoryItem)) {
        const restriction = inventoryItem.restriction.trim();
        const isWeapon = restriction.toLowerCase().includes('weapon');
        const message = isWeapon
          ? `‚õî Certification Required - You cannot requisition this item without proper weapon certification.`
          : `‚õî ${restriction} Restriction - You do not have access to requisition this item.`;
        showToast(message, 'error');
        console.warn('Access denied for restricted item:', name, 'Restriction:', restriction);
        return;
      }

      let quantity = parseInt(quantityInput.value);
      const sanitizedName = sanitizeInput(name);
      const sanitizedFullName = sanitizeInput(fullName);
      let maxQuantity = 5;
      if (inventoryItem) {
        const categoryLower = inventoryItem.category.toLowerCase();
        if (categoryLower === 'kit' || categoryLower === 'ship' || categoryLower === 'ship component') {
          maxQuantity = 1;
        }
      }

      if (!quantity || quantity < 1 || quantity > maxQuantity || !Number.isInteger(quantity)) {
        console.error('Invalid quantity:', quantity);
        showToast(`Invalid quantity. Must be between 1 and ${maxQuantity}.`, 'error');
        quantityInput.value = 1;
        return;
      }

      const existingItem = cart.find(item => item.name === sanitizedName);

      if (existingItem) {
        // Check if adding would exceed max
        const newTotal = existingItem.quantity + quantity;
        if (newTotal > maxQuantity) {
          const canAdd = maxQuantity - existingItem.quantity;
          if (canAdd > 0) {
            existingItem.quantity = maxQuantity;
            showToast(`Added ${canAdd}x ${name} (max ${maxQuantity} reached)`, 'warning');
          } else {
            showToast(`Maximum ${maxQuantity} already in cart for ${name}`, 'error');
            return;
          }
        } else {
          existingItem.quantity = newTotal;
          showToast(`Added ${quantity}x ${name} to request!`);
        }
      } else {
        cart.push({
          name: sanitizedName,
          fullName: sanitizedFullName,
          price: 'Free',
          quantity
        });
        showToast(`Added ${quantity}x ${name} to request!`);
      }

      updateCartCount();
      renderCartSidebar();
    }

    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';
      return input.trim().substring(0, 100).replace(/[<>\"'&]/g, '');
    }

    function validateDiscordUsername(username) {
      if (!username || typeof username !== 'string') {
        return false;
      }

      const discordRegex = /^[a-zA-Z0-9_.]{2,32}$/;
      const hasLetter = /[a-zA-Z]/;

      return discordRegex.test(username) && hasLetter.test(username);
    }

    function showOrderSuccessModal(orderId, message) {
      const modal = document.getElementById('order-success-modal');
      const orderIdElement = document.getElementById('modal-order-id');
      const messageElement = document.getElementById('modal-message');
      orderIdElement.textContent = `ORDER ID: ${orderId}`;
      messageElement.innerHTML = message.replace(/\n/g, '<br>');
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeOrderModal() {
      const modal = document.getElementById('order-success-modal');
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    function downloadReceipt() {
      if (!window.orderReceiptData) {
        alert('Receipt data not available');
        return;
      }

      const { fullReceipt, orderId, discordUsername } = window.orderReceiptData;
      const blob = new Blob([fullReceipt], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `medrunner-logistics-order-${discordUsername}-${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      closeOrderModal();
    }

    function goToTracking() {
      closeOrderModal();
      window.location.href = 'order-status.html';
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartCount();
      renderCartSidebar();
    }

    function updateQuantity(index, newQuantity) {
      if (newQuantity <= 0) {
        removeFromCart(index);
      } else {
        const item = cart[index];
        const nameLower = item.name.toLowerCase();
        let maxQuantity = 5;

        if (nameLower.includes('kit')) {
          maxQuantity = 1;
        } else {
          const inventoryItem = Object.values(window.inventoryData || {}).find(invItem => invItem.name === item.name);
          if (inventoryItem) {
            const categoryLower = inventoryItem.category.toLowerCase();
            if (categoryLower === 'ship' || categoryLower === 'ship component') {
              maxQuantity = 1;
            }
          }
        }

        // Allow decreasing even if currently above max (to fix spam bug)
        // Only block if trying to INCREASE above max
        if (newQuantity > maxQuantity && newQuantity > item.quantity) {
          showToast(`Maximum ${maxQuantity} allowed for ${item.name}`, 'error');
          return;
        }

        // Update quantity - cap at max only if increasing
        if (newQuantity > item.quantity) {
          // Increasing - cap at max
          cart[index].quantity = Math.min(newQuantity, maxQuantity);
        } else {
          // Decreasing - allow it
          cart[index].quantity = newQuantity;
        }
        updateCartCount();
        renderCartSidebar();
      }
    }

    function parsePrice(priceStr) {
      if (priceStr.toLowerCase().includes('free')) {
        return 0;
      }
      const parsed = parseInt(priceStr.replace(/[^\d]/g, ''));
      return isNaN(parsed) ? 0 : parsed;
    }

    function formatPrice(price) {
      return price.toLocaleString() + ' aUEC';
    }

    function calculateTotal() {
      const subtotal = cart.reduce((sum, item) => {
        const itemPrice = parsePrice(item.price);
        return sum + (itemPrice * item.quantity);
      }, 0);
      
      const collectionRadio = document.getElementById('collection-radio');
      const isCollection = collectionRadio && collectionRadio.checked;
      const collectionTax = isCollection ? Math.round(subtotal * 0.1) : 0;
      const total = subtotal + collectionTax;
      
      return { subtotal, collectionTax, total };
    }

    function renderCartSidebar() {
      const cartItems = document.getElementById('cart-items-sidebar');
      const requestDetailsContent = document.getElementById('request-details-content');

      if (cart.length === 0) {
        cartItems.innerHTML = '<p class="text-gray-400 text-center py-8">Your request is empty</p>';
        if (requestDetailsContent) {
          requestDetailsContent.innerHTML = '<p class="text-gray-400 text-sm">Your requested equipment will be listed here</p>';
        }
        return;
      }

      cartItems.innerHTML = cart.map((item, index) => {
        let maxQuantity = 5;
        let limitText = '';

        let inventoryItem = null;
        for (const invItem of Object.values(window.inventoryData || {})) {
          if (sanitizeInput(invItem.name) === item.name) {
            inventoryItem = invItem;
            break;
          }
        }

        if (inventoryItem) {
          const categoryLower = inventoryItem.category.toLowerCase();
          if (categoryLower === 'kit' || categoryLower === 'ship' || categoryLower === 'ship component') {
            maxQuantity = 1;
            limitText = '<p class="text-xs text-yellow-400">Limit: 1 per order</p>';
          } else {
            limitText = '<p class="text-xs text-yellow-400">Limit: 5 per order</p>';
          }
        } else {
          limitText = '<p class="text-xs text-yellow-400">Limit: 5 per order</p>';
        }

        return `
          <div class="bg-gray-700 p-3 rounded-lg">
            <div class="mb-2">
              <h3 class="font-bold text-sm">${item.name}</h3>
              <p class="text-xs text-gray-300">${item.fullName}</p>
              <p class="text-xs text-green-400">Free</p>
              ${limitText}
            </div>
            <div class="flex justify-between items-center">
              <div class="flex items-center space-x-2">
                <button onclick="updateQuantity(${index}, ${item.quantity - 1})" class="bg-red-600 px-2 py-1 rounded hover:bg-red-500 text-xs">-</button>
                <span class="text-sm">${item.quantity}</span>
                <button onclick="updateQuantity(${index}, Math.min(${item.quantity + 1}, ${maxQuantity}))" class="bg-green-600 px-2 py-1 rounded hover:bg-green-500 text-xs ${item.quantity >= maxQuantity ? 'opacity-50 cursor-not-allowed' : ''}">+</button>
              </div>
              <div class="text-right">
                <button onclick="removeFromCart(${index})" class="text-red-400 hover:text-red-300 text-xs">Remove</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      if (requestDetailsContent) {
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        requestDetailsContent.innerHTML = `
          <div class="space-y-2">
            <p class="text-sm text-gray-300"><strong>Total Items:</strong> ${totalItems}</p>
            <div class="space-y-1">
              ${cart.map(item => `
                <div class="flex justify-between text-sm">
                  <span class="text-gray-300">${item.quantity}x ${item.name}</span>
                  <span class="text-green-400">Free</span>
                </div>
              `).join('')}
            </div>
            <div class="border-t border-gray-600 pt-2 mt-2">
              <p class="text-sm text-blue-300">üìç Collection:  CRU-L1</p>
            </div>
          </div>
        `;
      }
    }

    function toggleCart() {
      if (orderProcessing) {
        alert('‚è≥ Please wait while your order is being processed. The cart will close automatically when complete.');
        return;
      }

      const sidebar = document.getElementById('cart-sidebar');
      const overlay = document.getElementById('cart-overlay');

      if (sidebar.classList.contains('translate-x-full')) {
        sidebar.classList.remove('translate-x-full');
        overlay.classList.remove('hidden');
        renderCartSidebar();
      } else {
        sidebar.classList.add('translate-x-full');
        overlay.classList.add('hidden');
      }
    }

    async function checkout() {
      if (cart.length === 0) {
        alert('Your cart is empty!');
        return;
      }

      const stockIssues = validateCartStock();
      if (stockIssues.length > 0) {
        const issueMessages = stockIssues.map(issue =>
          `‚Ä¢ ${issue.item.name}: Requesting ${issue.requestedQuantity}, only ${issue.availableStock} available`
        );

        const userChoice = confirm(
          `‚ö†Ô∏è STOCK ISSUES DETECTED:\n\n${issueMessages.join('\n')}\n\n` +
          `Click OK to automatically fix these issues and continue checkout.\n` +
          `Click Cancel to review your cart manually.`
        );

        if (userChoice) {
          fixCartStockIssues();
        } else {
          showToast('Please review your cart and adjust quantities.', 'error');
          return;
        }
      }

      document.getElementById('discord-username').style.borderColor = '#2c5278';
      const discordUsername = document.getElementById('discord-username');

      let hasErrors = false;

      if (!discordUsername || !discordUsername.value.trim()) {
        discordUsername.style.borderColor = '#ff0000';
        showToast('Please enter your Discord username', 'error');
        hasErrors = true;
      } else if (!validateDiscordUsername(discordUsername.value.trim())) {
        discordUsername.style.borderColor = '#ff0000';
        showToast('Invalid Discord username format. Must be 2-32 characters, letters/numbers/underscore/period, cannot be only numbers.', 'error');
        hasErrors = true;
      }

      const rookieKitCount = cart.filter(item => item.name.toLowerCase().includes('rookie kit')).reduce((sum, item) => sum + item.quantity, 0);
      const academyKitCount = cart.filter(item => item.name.toLowerCase().includes('academy')).reduce((sum, item) => sum + item.quantity, 0);

      if (rookieKitCount > 1) {
        showToast('Only 1 Rookie Kit allowed per order', 'error');
        hasErrors = true;
      }

      if (academyKitCount > 1) {
        showToast('Only 1 Academy Kit allowed per order', 'error');
        hasErrors = true;
      }

      if (hasErrors) {
        return;
      }

      // Validate availability slots
      const availabilityData = getAvailabilityData();
      if (availabilityData.count < 2) {
        showToast('Please select at least 2 availability time slots', 'error');
        return;
      }

      const currentTimestamp = Math.floor(Date.now() / 1000);
      const currentDate = new Date().toLocaleString('en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });

      orderProcessing = true;

      const checkoutButton = document.querySelector('button[onclick="checkout()"]');
      const originalButtonText = checkoutButton.innerHTML;
      checkoutButton.innerHTML = '‚è≥ Processing Order...';
      checkoutButton.disabled = true;

      const statusDiv = document.getElementById('sheets-status');
      const statusText = document.getElementById('sheets-status-text');
      if (statusDiv && statusText) {
        statusDiv.classList.remove('hidden');
        statusText.textContent = 'üì§ Uploading order to management system...';
        statusText.style.backgroundColor = '#3b82f6';
        statusText.style.color = '#fff';
      }

      let uploadSuccess = false;
      let retryCount = 0;
      const maxRetries = 3;
      let orderId = null;
      let confirmationMessage = '';

      while (!uploadSuccess && retryCount < maxRetries) {
        try {
          // Get Discord User ID from authenticated user
          const currentUser = window.MEDRUNNER_AUTH && window.MEDRUNNER_AUTH.getUser ? window.MEDRUNNER_AUTH.getUser() : null;
          const discordId = currentUser && currentUser.discordId ? currentUser.discordId : '';

          const response = await sendToMedrunnerSystem({
            timestamp: currentTimestamp,
            date: currentDate,
            discordUsername: discordUsername.value.trim(),
            discordId: discordId,
            items: cart.map(item => ({
              name: item.name,
              fullName: item.fullName,
              price: item.price,
              quantity: item.quantity
            })),
            availability: availabilityData.ranges,
            status: 'Received',
            paymentReceived: false,
            itemTransferred: false
          });
          orderId = response.data.orderId;
          confirmationMessage = `Request ID: ${orderId}\n`;
          confirmationMessage += `Requested by: ${discordUsername.value.trim()}\n`;
          confirmationMessage += `Collection: CRU-L1\n\n`;
          confirmationMessage += `Equipment Requested:\n`;
          cart.forEach((item, index) => {
            confirmationMessage += `‚Ä¢ ${item.quantity}x ${item.name}\n`;
          });
          confirmationMessage += `\nYour request has been submitted to logistics for processing.`;
          window.orderReceiptData = {
            confirmationMessage: confirmationMessage,
            orderId: orderId,
            discordUsername: discordUsername.value.trim()
          };

          uploadSuccess = true;
          if (statusDiv && statusText) {
            statusText.textContent = '‚úîÔ∏è Order successfully uploaded!';
            statusText.style.backgroundColor = '#10b981';
            statusText.style.color = '#fff';
          }

        } catch (error) {
          console.error(`Upload attempt ${retryCount + 1} failed:`, error);
          const isCorsError = error.message && (
            error.message.includes('NetworkError') ||
            error.message.includes('CORS') ||
            error.message.includes('Cross-Origin') ||
            error.name === 'TypeError'
          );

          if (isCorsError) {
            console.log('CORS error detected - Please review if data was uploaded');
            uploadSuccess = true;

            if (statusDiv && statusText) {
              statusText.textContent = '‚úîÔ∏è Order placed';
              statusText.style.backgroundColor = '#10b981';
              statusText.style.color = '#fff';
            }
            break;
          }

          retryCount++;

          if (retryCount < maxRetries) {
            if (statusDiv && statusText) {
              statusText.textContent = `üîÑ Something went wrong, retrying... (${retryCount}/${maxRetries})`;
              statusText.style.backgroundColor = '#f59e0b';
              statusText.style.color = '#000';
            }
            await new Promise(resolve => setTimeout(resolve, 1000));
          } else {
            if (statusDiv && statusText) {
              statusText.textContent = '‚ùå Unable to place order. Please alert AngelicFluffy.';
              statusText.style.backgroundColor = '#ef4444';
              statusText.style.color = '#fff';
            }

            checkoutButton.innerHTML = originalButtonText;
            checkoutButton.disabled = false;
            orderProcessing = false;

            alert('‚ùå Failed to place order after multiple attempts.\n\nPlease try again or contact support if the issue persists.\n\nYour order has NOT been processed.');
            return;
          }
        }
      }

      if (uploadSuccess) {
        if (statusDiv && statusText) {
          statusText.textContent = 'üìÑ Generating receipt...';
          statusText.style.backgroundColor = '#3b82f6';
          statusText.style.color = '#fff';}
        showOrderSuccessModal(orderId, confirmationMessage);
        cart = [];
        updateCartCount();
        renderCartSidebar();

        // Reset Discord username field only if not auto-filled from auth
        if (discordUsername && !discordUsername.readOnly) {
          discordUsername.value = '';
        }

        checkoutButton.innerHTML = originalButtonText;
        checkoutButton.disabled = false;
        orderProcessing = false;
        if (statusDiv && statusText) {
          statusText.textContent = '‚úîÔ∏è Order completed successfully!';
          statusText.style.backgroundColor = '#10b981';
          statusText.style.color = '#fff';
          setTimeout(() => {
            statusDiv.classList.add('hidden');
            toggleCart();
          }, 3000);
        }
      }
    }

    function addBundleToCart(name, price, button) {
      const card = button.closest('.equipment-card');
      const quantityInput = card.querySelector('.quantity-input');
      const quantity = quantityInput ? parseInt(quantityInput.value) : 1;
      const existingItem = cart.find(item => item.name === name);
      if (existingItem) {
        existingItem.quantity += quantity;
      } else {
        cart.push({
          name,
          fullName: name,
          price: 'Free',
          quantity
        });
      }
      updateCartCount();
      renderCartSidebar();
      showToast(`Added ${quantity}x ${name} to request!`);
    }

    function showToast(message) {
      const toast = document.getElementById('toast-notification');
      const toastMessage = document.getElementById('toast-message');
      toastMessage.textContent = message;
      toast.style.transform = 'translateX(0)';
      toast.style.opacity = '1';
      setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        toast.style.opacity = '0';
      }, 3000);
    }

    document.addEventListener('DOMContentLoaded', updateCartCount);
    function getTimeAgo(date) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      const diffInDays = Math.floor(diffInSeconds / (24 * 60 * 60));
      
      if (diffInDays === 0) return 'today';
      if (diffInDays === 1) return '1 day ago';
      return `${diffInDays} days ago`;
    }
    function toggleItemsDropdown() {
      const dropdown = document.getElementById('items-dropdown');
      dropdown.classList.toggle('hidden');
    }
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('items-dropdown');
      const button = event.target.closest('button');

      if (!button || !button.onclick || button.onclick.toString().indexOf('toggleItemsDropdown') === -1) {
        dropdown.classList.add('hidden');
      }
    });
    function validateMedrunnerConfig() {
      if (!window.MEDRUNNER_CONFIG) {
        throw new Error('Medrunner configuration not loaded.');
      }
      if (!window.MEDRUNNER_CONFIG.APPS_SCRIPT_URL || !window.MEDRUNNER_CONFIG.SHEET_ID) {
        throw new Error('Medrunner configuration not set up. Please update medrunner-config.js with your Google Sheet and Apps Script details.');
      }

      return true;
    }

    async function sendToMedrunnerSystem(requestData) {
      try {
        validateMedrunnerConfig();
      } catch (error) {
        throw new Error(`Configuration Error: ${error.message}`);
      }

      const { APPS_SCRIPT_URL } = window.MEDRUNNER_CONFIG;
      const secureRequestData = {
        action: 'submitRequest',
        orderId: sanitizeInput(requestData.orderId),
        timestamp: requestData.timestamp,
        date: requestData.date,
        discordUsername: sanitizeInput(requestData.discordUsername),
        discordId: sanitizeInput(requestData.discordId || ''),
        items: JSON.stringify(requestData.items.map(item => ({
          name: sanitizeInput(item.name),
          fullName: sanitizeInput(item.fullName),
          quantity: parseInt(item.quantity)
        }))),
        availability: sanitizeInput(requestData.availability || ''),
        notes: sanitizeInput(requestData.notes || '')
      };
      // Only log in development mode - comment out for production
      // console.log('Sending equipment request:', secureRequestData.orderId);

      // Use JSONP with retry to bypass CORS
      const jsonResult = await fetchWithRetry(APPS_SCRIPT_URL, secureRequestData);

      if (!jsonResult.success) {
        console.error('‚ùå Server returned error:', jsonResult.message);
        throw new Error(jsonResult.message || 'Server-side validation failed');
      }

      // Success - only log order ID
      console.log('‚úì Order submitted:', jsonResult.data?.orderId || 'Unknown ID');

      return jsonResult;
    }

    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('weapons-dropdown');
      const button = event.target.closest('button');

      if (dropdown && (!button || !button.onclick || button.onclick.toString().indexOf('toggleWeaponsDropdown') === -1)) {
        dropdown.classList.add('hidden');
      }
    })
  </script>
</body>

</html>
